# 🕐 狗狗智能体 - 时间行为系统说明

## 系统概述

实现了方案 A（时间模拟 + 行为状态机）+ 时间加速接口，让狗狗的行为更真实，支持长时间行为模拟。

## 核心设计

### 1. 行为分类

#### 🏃 快速行为（瞬间完成）
- **生理类**: 伸懒腰、打哈欠、舔毛
- **社交类**: 摇尾巴、蹭主人、舔手、跟随、抬头看主人
- **探索类**: 嗅地板、绕圈、扒东西、看窗外、追光点
- **情绪类**: 吠叫、低吼、耳朵夹起、尾巴夹起、跳跃
- **训练类**: 坐下、趴下、握手、打滚、装死、取物
- **特殊类**: 抓痒、打喷嚏、抖毛、打呼、做梦抽搐

特点：
- Tool 立即返回
- 不阻塞其他行为
- 可以在长时行为中执行

#### 🛏️ 长时行为（需要时间完成）
- **睡觉 (sleep)**: 2-4 小时（虚拟时间）
- **吃饭 (eat_food)**: 12 分钟（虚拟时间）
- **喝水 (drink_water)**: 8 分钟（虚拟时间）

特点：
- Tool 立即返回，但设置行为状态
- 持续一段虚拟时间
- 执行期间不能开始其他长时行为
- 可以被主人打断
- 持续产生效果（如睡觉持续降低疲劳）

### 2. 时间加速系统

#### 时间比例

```
time_scale = 实际秒数对应的虚拟分钟数
```

| 倍数 | 说明 | 实际效果 | 适用场景 |
|------|------|---------|---------|
| 1x | 真实时间 | 1秒 = 1秒 | 长期运行 |
| 60x | 标准（默认） | 1秒 = 1分钟 | 推荐使用 |
| 120x | 快速 | 1秒 = 2分钟 | 快速测试 |
| 360x | 演示 | 1秒 = 6分钟 | 快速演示 |

#### 实际时间计算

**示例（60x 时间加速）**:
- 睡觉 120 虚拟分钟 = 120/60 = **2 分钟实际时间**
- 吃饭 12 虚拟分钟 = 12/60 = **12 秒实际时间**
- 喝水 8 虚拟分钟 = 8/60 = **8 秒实际时间**

### 3. 状态更新机制

#### 自动状态衰减
状态值会随虚拟时间自动变化：
- 饥饿值: +2/虚拟分钟
- 口渴值: +1.5/虚拟分钟
- 疲劳值: +1/虚拟分钟（睡觉时不增加）
- 无聊值: +1.5/虚拟分钟

#### 长时行为持续效果

**睡觉期间**:
```python
# 疲劳值持续降低（从开始时的值）
progress = 已睡时间 / 总睡眠时间
疲劳值 = 80 * (1 - progress)  # 逐渐降到 0

# 睡眠期间不会饥饿、口渴、疲劳、无聊
```

**吃饭期间**:
```python
# 饥饿值持续降低
progress = 已吃时间 / 总进食时间
饥饿值 = 初始饥饿值 * (1 - progress)
```

**喝水期间**:
```python
# 口渴值持续降低
progress = 已喝时间 / 总饮水时间
口渴值 = 初始口渴值 * (1 - progress)
```

## 使用指南

### 启动程序

```bash
uv run python dog_agent_gradio.py
```

### UI 操作

#### 时间加速设置
1. 点击右侧的 **"⚙️ 时间加速设置"** 折叠面板
2. 使用滑动条调整倍数（1-360x）
3. 或选择预设值：
   - 1x 真实
   - 60x 标准（推荐）
   - 120x 快速
   - 360x 演示

#### 查看行为进度
在 **"🐾 当前行为"** 框中会显示：
```
🔄 正在睡觉中...
进度: ████████░░░░░░░░░░░░ 40.5%
已用时间: 48.6 分钟
剩余时间: 71.4 分钟
```

#### 打断长时行为
如果狗狗正在睡觉、吃饭或喝水，你可以：
1. 直接给指令（如"过来"）
2. LLM 会自动调用 `interrupt_current_behavior()` 工具
3. 狗狗会停止当前行为并回应

### 交互示例

#### 示例 1: 让狗狗睡觉
```
你: 去睡觉吧
狗狗: 🐾 蜷缩起来...闭上眼睛...zzz... 开始睡觉... (需要 180 分钟)

[当前行为显示]
🔄 正在睡觉中...
进度: █░░░░░░░░░░░░░░░░░░░ 5.0%
已用时间: 9.0 分钟
剩余时间: 171.0 分钟
```

#### 示例 2: 睡觉中被打断
```
你: 过来
LLM: (自动检测到狗狗正在睡觉，调用 interrupt_current_behavior)
狗狗: 🐾 被主人叫醒/打断，停止了之前的行为
     🐾 用大眼睛抬头看着主人...等待关注！
     🐾 紧紧跟随主人...待在主人身边！
```

#### 示例 3: 忙碌时尝试新行为
```
你: 喝水
狗狗: 🐾 狗狗正在睡觉，不能开始新行为
```

## 技术实现

### 文件修改

#### 1. dog_state.py
**新增字段**:
```python
current_behavior: str = None           # 当前行为类型
behavior_start_time: float = None      # 开始时间
behavior_duration: float = None        # 持续时间（虚拟分钟）
behavior_description: str = None       # 显示描述
```

**新增方法**:
- `start_behavior()`: 开始长时行为
- `interrupt_behavior()`: 打断当前行为
- `is_busy()`: 检查是否正忙
- `get_behavior_progress()`: 获取进度信息
- `_update_behavior_progress()`: 更新行为进度
- `_complete_behavior()`: 完成行为

**时间加速**:
```python
def __init__(self, time_scale: float = 1.0):
    self.time_scale = time_scale
```

#### 2. dog_behaviors.py
**修改的长时行为**:
- `sleep()`: 2-4 小时虚拟时间
- `eat_food()`: 12 虚拟分钟
- `drink_water()`: 8 虚拟分钟

**新增工具**:
- `interrupt_current_behavior()`: 打断工具

#### 3. dog_agent_gradio.py
**UI 新增**:
- 时间加速控制面板（滑动条 + 预设按钮）
- 行为进度显示（进度条 + 时间统计）

**逻辑新增**:
- `set_time_scale()`: 动态调整时间加速
- 增强的 `get_current_activity()`: 显示进度信息

## 高级特性

### 1. 动态调整时间加速
可以在运行中随时调整，立即生效：
```python
# 从 60x 调到 120x
# 原本需要 2 分钟的睡眠，现在只需 1 分钟
```

### 2. 行为完成回调
行为自动完成时会：
- 打印日志
- 应用最终效果
- 更新快乐值
- 清除行为状态

### 3. 状态持久化
所有状态（包括当前行为）都保存到 SQLite：
- 重启后可以继续未完成的行为
- 时间计算基于实际时间戳

## 调试和监控

### 命令行日志
```
[BEHAVIOR] Started sleeping for 180 virtual minutes (actual: 3.0 minutes)
[BEHAVIOR] Dog finished sleeping, fully rested!
[TIME_SCALE] Updated to 120x (1 second = 120 virtual minutes)
```

### 状态查询
在 Agent 提示词中会显示：
```
当前状态: 正在睡觉
- 已进行: 45.2 分钟
- 还需要: 134.8 分钟
- 进度: 25.1%
```

## 最佳实践

1. **推荐时间加速**: 60x（1秒 = 1分钟）
   - 平衡真实感和响应速度
   - 8分钟喝水 = 8秒实际时间

2. **演示模式**: 360x（1秒 = 6分钟）
   - 快速展示完整流程
   - 2小时睡眠 = 20秒实际时间

3. **长期运行**: 1x（真实时间）
   - 作为真实宠物陪伴
   - 睡眠真的需要几小时

## 未来扩展

可以添加更多长时行为：
- **玩耍**: 30 分钟（降低无聊值）
- **散步**: 60 分钟（降低所有负面状态）
- **训练**: 20 分钟（提高技能熟练度）
- **美容**: 15 分钟（提高快乐值）

每个行为都可以有：
- 自定义持续时间
- 持续状态变化
- 完成奖励
- 中断处理

## 总结

通过时间模拟 + 状态机的方式，我们实现了：
✅ Tool 快速返回（不阻塞）
✅ 真实的时间流逝感
✅ 可调节的时间加速
✅ 持续的状态更新
✅ 灵活的行为打断
✅ 清晰的进度显示

这让狗狗智能体更加真实和有趣！🐕✨

